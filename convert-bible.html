<!DOCTYPE html>
<html>
<head>
    <title>Bible Converter</title>
</head>
<body>
    <h1>Bible Format Converter</h1>
    <p>This will convert the GitHub Bible format to our project format.</p>
    
    <button id="downloadBtn">Download & Convert Bible</button>
    <div id="status"></div>
    <textarea id="output" style="width:100%; height:400px; display:none;"></textarea>
    
    <script>
        class BibleConverter {
            convertGitHubFormat(githubBible) {
                const converted = {};
                
                githubBible.forEach(book => {
                    const bookName = book.name;
                    converted[bookName] = {};
                    
                    book.chapters.forEach((chapter, chapterIndex) => {
                        const chapterNum = chapterIndex + 1;
                        converted[bookName][chapterNum] = {};
                        
                        chapter.forEach((verse, verseIndex) => {
                            const verseNum = verseIndex + 1;
                            converted[bookName][chapterNum][verseNum] = verse;
                        });
                    });
                });
                
                return converted;
            }

            async downloadAndConvert() {
                const urls = [
                    'https://raw.githubusercontent.com/aruljohn/Bible-kjv/master/bible_kjv.json',
                    'https://raw.githubusercontent.com/aruljohn/Bible-kjv/master/Gideons.json',
                    'https://raw.githubusercontent.com/seven1m/bible_api/master/bibles/kjv.json'
                ];
                
                for (let url of urls) {
                    try {
                        document.getElementById('status').innerHTML = `Trying: ${url.split('/').pop()}...`;
                        const response = await fetch(url);
                        const text = await response.text();
                        
                        // Clean the text and try to parse
                        const cleanText = text.trim().replace(/^[^\[{]*/, '').replace(/[^\]}]*$/, '');
                        const githubBible = JSON.parse(cleanText);
                        
                        document.getElementById('status').innerHTML = 'Converting format...';
                        const converted = this.convertGitHubFormat(githubBible);
                        
                        document.getElementById('status').innerHTML = 'Conversion complete! Copy the JSON below:';
                        document.getElementById('output').style.display = 'block';
                        document.getElementById('output').value = JSON.stringify(converted, null, 2);
                        
                        return converted;
                        
                    } catch (error) {
                        document.getElementById('status').innerHTML = `Failed: ${error.message}. Trying next source...`;
                        continue;
                    }
                }
                
                document.getElementById('status').innerHTML = 'All sources failed. Please download manually from GitHub.';
                return null;
            }
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const converter = new BibleConverter();
            converter.downloadAndConvert();
        });
    </script>
    
    <h2>Instructions:</h2>
    <ol>
        <li>Click "Download & Convert Bible" button</li>
        <li>Wait for conversion to complete</li>
        <li>Copy the JSON output</li>
        <li>Save as <code>assets/data/bible-kjv.json</code></li>
        <li>Replace your current bible-kjv.json file</li>
    </ol>
    
    <h3>Multiple Files Upload:</h3>
    <p>Since each book is a separate file:</p>
    <ol>
        <li>Go to <a href="https://github.com/aruljohn/Bible-kjv" target="_blank">GitHub Bible-kjv</a></li>
        <li>Download all .json files (or select multiple books)</li>
        <li>Upload multiple files: <input type="file" id="multiFileInput" accept=".json" multiple></li>
        <li>Click "Merge Files" after selecting: <button id="mergeBtn" style="display:none;">Merge Files</button></li>
    </ol>
    
    <div id="fileList"></div>
    
    <script>
        let selectedFiles = [];
        
        document.getElementById('multiFileInput').addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files);
            document.getElementById('fileList').innerHTML = `Selected ${selectedFiles.length} files: ${selectedFiles.map(f => f.name).join(', ')}`;
            document.getElementById('mergeBtn').style.display = selectedFiles.length > 0 ? 'inline' : 'none';
        });
        
        document.getElementById('mergeBtn').addEventListener('click', async () => {
            const mergedBible = {};
            let processedCount = 0;
            let successCount = 0;
            
            document.getElementById('status').innerHTML = 'Processing files...';
            
            for (let file of selectedFiles) {
                try {
                    const text = await readFileAsText(file);
                    const bookData = JSON.parse(text);
                    
                    // Debug: Show first file structure
                    if (processedCount === 0) {
                        console.log('First file structure:', file.name, bookData);
                        document.getElementById('status').innerHTML = `Analyzing structure of ${file.name}... Keys: ${Object.keys(bookData).join(', ')}`;
                    }
                    
                    let bookName = file.name.replace('.json', '').replace(/[0-9]/g, '').trim();
                    
                    // Handle GitHub format: {"book": "1 John", "chapters": [{"chapter": "1", "verses": [...]}]}
                    if (bookData.book && bookData.chapters) {
                        mergedBible[bookData.book] = convertGitHubBookFormat(bookData);
                        successCount++;
                    } else {
                        console.log('Unrecognized format for:', file.name, bookData);
                    }
                    
                    processedCount++;
                    if (processedCount % 10 === 0) {
                        document.getElementById('status').innerHTML = `Processed ${processedCount}/${selectedFiles.length} files (${successCount} books added)...`;
                    }
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    processedCount++;
                }
            }
            
            const bookCount = Object.keys(mergedBible).length;
            document.getElementById('status').innerHTML = `Merge complete! Found ${bookCount} books. Copy the JSON below:`;
            document.getElementById('output').style.display = 'block';
            document.getElementById('output').value = JSON.stringify(mergedBible, null, 2);
        });
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        function convertGitHubBookFormat(bookData) {
            const converted = {};
            bookData.chapters.forEach(chapter => {
                const chapterNum = chapter.chapter;
                converted[chapterNum] = {};
                chapter.verses.forEach(verse => {
                    converted[chapterNum][verse.verse] = verse.text;
                });
            });
            return converted;
        }
        
        function convertBookFormat(book) {
            const converted = {};
            book.chapters.forEach((chapter, chapterIndex) => {
                const chapterNum = chapterIndex + 1;
                converted[chapterNum] = {};
                chapter.forEach((verse, verseIndex) => {
                    const verseNum = verseIndex + 1;
                    converted[chapterNum][verseNum] = verse;
                });
            });
            return converted;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate All Reading Pages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Generate All Reading Pages</h1>
        <p>Generate HTML pages for all readings in your plan</p>
        
        <div class="mb-3">
            <label>Bible Version:</label>
            <select id="versionSelect" class="form-select">
                <option value="kjv">KJV</option>
                <option value="nkjv">NKJV</option>
            </select>
        </div>
        
        <button onclick="generateAllPages()" class="btn btn-primary">Generate All Pages</button>
        <button onclick="downloadZip()" class="btn btn-success">Download All as ZIP</button>
        
        <div id="progress" class="mt-3"></div>
        <div id="output" class="mt-4"></div>
    </div>

    <script src="assets/js/bible-generator.js?v=7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let generatedPages = {};

        async function generateAllPages() {
            const version = document.getElementById('versionSelect').value;
            const progress = document.getElementById('progress');
            
            progress.innerHTML = '<div class="alert alert-info">Loading Bible data...</div>';
            
            try {
                const generator = new BibleGenerator(version);
                await generator.loadData('assets/data/');
                
                const readingPlan = generator.readingPlan;
                const totalReadings = Object.keys(readingPlan).length;
                let completed = 0;
                
                generatedPages = {};
                
                for (const [dateCode, reading] of Object.entries(readingPlan)) {
                    progress.innerHTML = `<div class="alert alert-info">Generating ${dateCode} (${completed + 1}/${totalReadings})...</div>`;
                    
                    try {
                        const pageHtml = generator.generatePage(dateCode);
                        if (pageHtml) {
                            const month = getMonthName(dateCode.substring(0, 2));
                            const fileName = `${dateCode}.html`;
                            const folderPath = `readings/${month.toLowerCase()}/${fileName}`;
                            
                            generatedPages[folderPath] = pageHtml;
                        }
                    } catch (error) {
                        console.error(`Error generating ${dateCode}:`, error);
                    }
                    
                    completed++;
                }
                
                displayResults(completed);
                progress.innerHTML = '<div class="alert alert-success">Generation complete!</div>';
                
            } catch (error) {
                progress.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function getMonthName(monthNum) {
            const months = {
                '01': 'January', '02': 'February', '03': 'March', '04': 'April',
                '05': 'May', '06': 'June', '07': 'July', '08': 'August',
                '09': 'September', '10': 'October', '11': 'November', '12': 'December'
            };
            return months[monthNum] || 'Unknown';
        }

        function displayResults(count) {
            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="alert alert-success">
                    <h5>Generated ${count} reading pages!</h5>
                    <p>Pages are ready for download as ZIP file.</p>
                </div>
                <div class="mt-3">
                    <h6>Generated Files:</h6>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${Object.keys(generatedPages).map(path => `<div class="small">${path}</div>`).join('')}
                    </div>
                </div>
            `;
        }

        async function downloadZip() {
            if (Object.keys(generatedPages).length === 0) {
                alert('No pages generated yet');
                return;
            }
            
            const zip = new JSZip();
            
            // Create folder structure and add files
            for (const [filePath, content] of Object.entries(generatedPages)) {
                zip.file(filePath, content);
            }
            
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'reading-pages.zip';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>